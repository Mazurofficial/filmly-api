generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  displayName  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  refreshTokenHash String?
  refreshTokenExp  DateTime?

  library UserMovie[]
}

model Movie {
  id           String    @id @default(cuid())
  tmdbId       Int       @unique
  title        String
  runtimeMin   Int?
  posterPath   String?
  lastSyncedAt DateTime?

  users UserMovie[]
  genres MovieGenreOnMovie[]
}

model MovieGenre {
  id     Int     @id
  name   String
  movies MovieGenreOnMovie[]
}

model MovieGenreOnMovie {
  movieId Int
  genreId Int

  movie Movie     @relation(fields: [movieId], references: [tmdbId], onDelete: Cascade, onUpdate: Cascade)
  genre MovieGenre @relation(fields: [genreId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([movieId, genreId])
  @@index([genreId])
}

model UserMovie {
  id            String   @id @default(cuid())
  userId        String
  movieId       String
  status        String   // "watched" | "planned"
  rating        Int?
  watchCount    Int      @default(0)
  lastWatchedAt DateTime?
  note          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@index([userId])
  @@index([movieId])
}
